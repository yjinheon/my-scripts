# ============================================
# ğŸ“Œ DuckDB + PostgreSQL + MySQL + CSV ì‘ì—…ìš© JUSTFILE
#    - DuckDB íŒŒì¼/ë©”ëª¨ë¦¬ ì‹¤í–‰
#    - CSV/Parquet ì½ê¸°
#    - PostgreSQL/MySQL ì§ì ‘ ì½ê¸° (DuckDB FDW)
#    - psql ê¸°ë³¸ ì¡°ì‘
#    - í¸ì˜ ìœ í‹¸ë¦¬í‹°
# ============================================


# ===========================
#      MinIO í™˜ê²½ ì„¤ì •
# ===========================

export MINIO_ENDPOINT := "http://localhost:9000"     # http://minio:9000 ë„ ê°€ëŠ¥
export MINIO_ACCESS_KEY := "${MINIO_ACCESS_KEY}"
export MINIO_SECRET_KEY := "${MINIO_SECRET_KEY}"
export MINIO_REGION := "us-east-1"                   # MinIO ê¸°ë³¸ê°’

# bash ì‚¬ìš©
set shell := ["bash", "-cu"]

# ìì£¼ ì“°ëŠ” í™˜ê²½ ë³€ìˆ˜
export PG_HOST := "localhost"
export PG_USER := "postgres"
export PG_DB   := "postgres"
export PG_PORT := "5432"

export MYSQL_HOST := "localhost"
export MYSQL_USER := "root"
export MYSQL_PW   := ""
export MYSQL_DB   := "test"
export MYSQL_PORT := "3306"

export DUCKDB_FILE := "local.duckdb"


# ============================================
# ========== PostgreSQL (psql) ê´€ë ¨ ===========
# ============================================

# PostgreSQL ì‰˜ ì ‘ì†
@psql-shell:
    # PostgreSQL psql CLIì— ì ‘ì†
    psql -h $PG_HOST -U $PG_USER -d $PG_DB -p $PG_PORT

# DB ëª©ë¡ í™•ì¸ (í•œê¸€ ì£¼ì„)
@psql-list-db:
    # PostgreSQL ì„œë²„ì˜ ì „ì²´ ë°ì´í„°ë² ì´ìŠ¤ ëª©ë¡ ì¡°íšŒ
    psql -h $PG_HOST -U $PG_USER -p $PG_PORT -c "\l"

# íŠ¹ì • DBì˜ í…Œì´ë¸” ëª©ë¡ ì¡°íšŒ
@psql-tables db:
    # ë°ì´í„°ë² ì´ìŠ¤ ë‚´ í…Œì´ë¸” ëª©ë¡ í™•ì¸
    psql -h $PG_HOST -U $PG_USER -d {{db}} -c "\dt"

# í…Œì´ë¸” ìƒì„¸ ì •ë³´ ì¡°íšŒ
@psql-describe db table:
    psql -h $PG_HOST -U $PG_USER -d {{db}} -c "\d {{table}}"

# í…Œì´ë¸” ë ˆì½”ë“œ nê°œ ì¡°íšŒ
@psql-head db table n="10":
    psql -h $PG_HOST -U $PG_USER -d {{db}} \
         -c "SELECT * FROM {{table}} LIMIT {{n}};"

# PostgreSQL â†’ SQL dump íŒŒì¼ë¡œ ë°±ì—…
@pg-backup out="dump.sql":
    pg_dump -h $PG_HOST -U $PG_USER -d $PG_DB > {{out}}

# SQL íŒŒì¼ë¡œ ë³µì›
@pg-restore file:
    psql -h $PG_HOST -U $PG_USER -d $PG_DB -f {{file}}


# ============================================
# =============== DuckDB ê´€ë ¨ =================
# ============================================

# DuckDB íŒŒì¼ë¡œ ì‹¤í–‰
@duck:
    duckdb $DUCKDB_FILE

# DuckDB ë©”ëª¨ë¦¬ ëª¨ë“œë¡œ ì‹¤í–‰
@duck-memory:
    duckdb

# DuckDB ë‚´ í…Œì´ë¸” ëª©ë¡ í™•ì¸
@duck-tables:
    echo "SHOW ALL TABLES;" | duckdb $DUCKDB_FILE

# í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ ì¡°íšŒ
@duck-describe table:
    echo "DESCRIBE {{table}};" | duckdb $DUCKDB_FILE

# í…Œì´ë¸” 10ê°œ ì¡°íšŒ
@duck-head table:
    echo "SELECT * FROM {{table}} LIMIT 10;" | duckdb $DUCKDB_FILE


# ============================================
# ============== CSV ì½ê¸° ê´€ë ¨ ===============
# ============================================

# CSV ì½ì–´ì„œ ì¿¼ë¦¬ (DuckDB)
@duck-read-csv csv:
    # CSV íŒŒì¼ì—ì„œ 10ê°œë§Œ ë¯¸ë¦¬ë³´ê¸°
    echo "SELECT * FROM read_csv_auto('{{csv}}') LIMIT 10;" \
    | duckdb $DUCKDB_FILE

# CSV â†’ DuckDB í…Œì´ë¸”ë¡œ ì €ì¥
@duck-import-csv table csv:
    echo "CREATE OR REPLACE TABLE {{table}} AS SELECT * FROM read_csv_auto('{{csv}}');" \
    | duckdb $DUCKDB_FILE

# DuckDB í…Œì´ë¸” â†’ CSV ë‚´ë³´ë‚´ê¸°
@duck-export-csv table out:
    echo "COPY {{table}} TO '{{out}}' (HEADER, DELIMITER ',');" \
    | duckdb $DUCKDB_FILE


# ============================================
# ============== Parquet ê´€ë ¨ =================
# ============================================

# Parquet ë¯¸ë¦¬ë³´ê¸°
@duck-read-parquet file:
    echo "SELECT * FROM read_parquet('{{file}}') LIMIT 10;" | duckdb $DUCKDB_FILE

# DuckDB í…Œì´ë¸” â†’ Parquet ì €ì¥
@duck-export-parquet table out:
    echo "COPY {{table}} TO '{{out}}' (FORMAT PARQUET);" | duckdb $DUCKDB_FILE


# ============================================
# ======== DuckDBì—ì„œ PostgreSQL ì½ê¸° =========
# ============================================

# ğŸ”¥ DuckDBì—ì„œ PostgreSQL ì—°ê²° í›„ í…Œì´ë¸” ì¡°íšŒ
@duck-read-postgres table:
    # duckdbì—ì„œ postgres_scanner í™•ì¥ì„ ì„¤ì¹˜í•˜ê³  ì‚¬ìš© í›„ SELECT
    echo "
    INSTALL postgres_scanner;
    LOAD postgres_scanner;

    SELECT * FROM postgres_scan(
        host='$PG_HOST',
        port=$PG_PORT,
        database='$PG_DB',
        user='$PG_USER',
        password='',
        table='{{table}}'
    ) LIMIT 10;
    " | duckdb $DUCKDB_FILE

# ğŸ”¥ Postgres í…Œì´ë¸” â†’ DuckDB í…Œì´ë¸”ë¡œ ì €ì¥
@duck-import-postgres table:
    echo "
    INSTALL postgres_scanner;
    LOAD postgres_scanner;

    CREATE OR REPLACE TABLE {{table}} AS 
    SELECT * FROM postgres_scan(
        host='$PG_HOST',
        port=$PG_PORT,
        database='$PG_DB',
        user='$PG_USER',
        password='',
        table='{{table}}'
    );
    " | duckdb $DUCKDB_FILE


# ============================================
# ======== DuckDBì—ì„œ MySQL ì½ê¸° ==============
# ============================================

@duck-read-mysql table:
    echo "
    INSTALL mysql;
    LOAD mysql;

    SELECT * FROM mysql_scan(
        host='$MYSQL_HOST',
        port=$MYSQL_PORT,
        username='$MYSQL_USER',
        password='$MYSQL_PW',
        database='$MYSQL_DB',
        table='{{table}}'
    ) LIMIT 10;
    " | duckdb $DUCKDB_FILE

@duck-import-mysql table:
    echo "
    INSTALL mysql;
    LOAD mysql;

    CREATE OR REPLACE TABLE {{table}} AS
    SELECT * FROM mysql_scan(
        host='$MYSQL_HOST',
        port=$MYSQL_PORT,
        username='$MYSQL_USER',
        password='$MYSQL_PW',
        database='$MYSQL_DB',
        table='{{table}}'
    );
    " | duckdb $DUCKDB_FILE


# ============================================
# ============== ìœ í‹¸ë¦¬í‹° =====================
# ============================================

# SQL í¬ë§·íŒ…
@sql-format file:
    sqlformat --reindent --keywords upper --identifiers lower {{file}}

# CPU ì‚¬ìš©ëŸ‰ watcher
@watch-cpu:
    watch -n 1 "ps -eo pid,ppid,cmd,%mem,%cpu --sort=-%cpu | head"


# ============================================
# =========== DuckDB: MinIO Parquet ==========
# ============================================

@duck-minio-read-parquet bucket key:
    # ì˜ˆì‹œ: just duck-minio-read-parquet mybucket data/file.parquet
    echo "
    INSTALL httpfs;
    LOAD httpfs;

    -- MinIO endpoint ì„¤ì •
    SET s3_endpoint='{{MINIO_ENDPOINT}}';
    SET s3_url_style='path';
    SET s3_use_ssl=false;

    SET s3_access_key_id='{{MINIO_ACCESS_KEY}}';
    SET s3_secret_access_key='{{MINIO_SECRET_KEY}}';
    SET s3_region='{{MINIO_REGION}}';

    SELECT * FROM read_parquet('s3://{{bucket}}/{{key}}') LIMIT 10;
    " | duckdb $DUCKDB_FILE



@duck-minio-read-csv bucket key:
    echo "
    INSTALL httpfs;
    LOAD httpfs;

    SET s3_endpoint='{{MINIO_ENDPOINT}}';
    SET s3_url_style='path';
    SET s3_use_ssl=false;

    SET s3_access_key_id='{{MINIO_ACCESS_KEY}}';
    SET s3_secret_access_key='{{MINIO_SECRET_KEY}}';
    SET s3_region='{{MINIO_REGION}}';

    SELECT * FROM read_csv_auto('s3://{{bucket}}/{{key}}') LIMIT 10;
    " | duckdb $DUCKDB_FILE



@duck-minio-read-parquet-dir bucket prefix:
    echo "
    INSTALL httpfs;
    LOAD httpfs;

    SET s3_endpoint='{{MINIO_ENDPOINT}}';
    SET s3_url_style='path';
    SET s3_use_ssl=false;

    SET s3_access_key_id='{{MINIO_ACCESS_KEY}}';
    SET s3_secret_access_key='{{MINIO_SECRET_KEY}}';
    SET s3_region='{{MINIO_REGION}}';

    SELECT * FROM read_parquet('s3://{{bucket}}/{{prefix}}/*.parquet') LIMIT 10;
    " | duckdb $DUCKDB_FILE
