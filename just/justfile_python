_ default:
    @just --choose -f {{ justfile() }} -d {{ invocation_directory() }}


# =========================
# init 
# =========================

# ì˜ì¡´ì„± ê´€ë¦¬
# - uv lock --upgrade : pyproject ê¸°ë°˜ìœ¼ë¡œ lock íŒŒì¼ ê°±ì‹ 
# - uv sync --all-extras --frozen : lock ê¸°ë°˜ìœ¼ë¡œ íŒ¨í‚¤ì§€ ë™ê¸°í™”
# - just hook : pre-commit hook ì„¤ì¹˜
install:
    uv lock --upgrade
    uv sync --all-extras --frozen
    @just hook

# git pre-commit hook ì„¤ì¹˜
# - pre-commit ì´ pyprojectì— í¬í•¨ë¼ ìˆì–´ì•¼ í•¨
hook:
    uv run pre-commit install
    @echo "pre-commit hook installed"


# =========================
# (Lint / Type check / Test)
# =========================

# ì½”ë“œ í¬ë§·íŒ… ë° ìë™ ìˆ˜ì • ë¦°í„° ì‹¤í–‰
# - ruff format: Python ì½”ë“œ í¬ë§·íŒ… 
# - ruff check --fix: ë¦°í„° ì‹¤í–‰ ë° ìˆ˜ì • ê°€ëŠ¥í•œ ë¬¸ì œ ìë™ ìˆ˜ì •
# - mypy: íƒ€ì… ì–´ë…¸í…Œì´ì…˜ì´ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•˜ëŠ” íƒ€ì… ì²´ì»¤
lint:
    uv run ruff format
    uv run ruff check --fix
    uv run mypy .

# í…ŒìŠ¤íŠ¸ ì‹¤í–‰
# ì‚¬ìš© ì˜ˆì‹œ:
#   just test                     # ì „ì²´ í…ŒìŠ¤íŠ¸
#   just test tests/test_api.py   # íŠ¹ì • íŒŒì¼
#   just test -k "test_login"     # íŒ¨í„´ ë§¤ì¹­
#   just test -v                  # verbose
test *args:
    uv run --no-sync pytest {{ args }}

# CIìš© ì „ì²´ ì²´í¬ (lint + test)
check:
    @just lint
    @just test


# =========================
# FastAPI
# =========================

#dev
serve-dev:
    @echo "starting FastAPI Development server with hot reload..."
    uv run uvicorn app.main:app --reload --host 0.0.0.0 --port 5001

# prod 
serve-prod:
    @echo "FastAPI Production server starting with 4 workers..."
    uv run uvicorn app.main:app --host 0.0.0.0 --port 8000 --workers 4

# ì»¤ìŠ¤í…€ host/port ì„œë²„ (ì˜ˆ: just serve-custom 127.0.0.1 5001)
serve-custom host port:
    @echo "starting FastAPI server ({{host}}:{{port}})..."
    uv run uvicorn app.main:app --reload --host {{host}} --port {{port}}

# server.py ì“°ê³  ì‹¶ì„ ë•Œ (ë„¤ê°€ ë§Œë“  launcher í™œìš©)
serve-dev-py:
    @echo "starting FastAPI via server.py..."
    uv run python server.py


# =========================
# Alembic
# =========================

# í˜„ì¬ ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒíƒœ í™•ì¸
alembic-current:
    uv run alembic current

# ë§ˆì´ê·¸ë ˆì´ì…˜ íˆìŠ¤í† ë¦¬ í™•ì¸
alembic-history:
    uv run alembic history --verbose

# í˜„ì¬ headë“¤ í™•ì¸ (ë¸Œëœì¹˜ ì—¬ëŸ¬ê°œì¼ ë•Œ)
alembic-heads:
    uv run alembic heads

# ìƒˆ ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒì„± (ìë™ ê°ì§€)
# ex:
#   just alembic-revision "add scv_task table"
alembic-revision msg:
    uv run alembic revision --autogenerate -m "{{msg}}"

# create blank migration 
#   just alembic-revision-blank "custom sql"
alembic-revision-blank msg:
    uv run alembic revision -m "{{msg}}"

# ë§ˆì´ê·¸ë ˆì´ì…˜ ì ìš© (ê¸°ë³¸: headê¹Œì§€)
# ì‚¬ìš© ì˜ˆì‹œ:
#   just alembic-upgrade         # headê¹Œì§€
#   just alembic-upgrade base    # baseê¹Œì§€
#   just alembic-upgrade 1234    # íŠ¹ì • ë¦¬ë¹„ì „
alembic-upgrade rev="head":
    uv run alembic upgrade {{rev}}

# ë§ˆì´ê·¸ë ˆì´ì…˜ ë¡¤ë°±
# ì‚¬ìš© ì˜ˆì‹œ:
#   just alembic-downgrade -1      # í•œ ë‹¨ê³„ ë¡¤ë°±
#   just alembic-downgrade base    # ì´ˆê¸° ìƒíƒœë¡œ
alembic-downgrade rev:
    uv run alembic downgrade {{rev}}

# íŠ¹ì • ë¦¬ë¹„ì „ìœ¼ë¡œ DB ìƒíƒœë§Œ í‘œì‹œ(stamp) â€“ ì‹¤ì œ ìŠ¤í‚¤ë§ˆ ë³€ê²½ ì—†ì´ versionë§Œ ë§ì¶”ê¸°
# ì‚¬ìš© ì˜ˆì‹œ:
#   just alembic-stamp head
#   just alembic-stamp base
alembic-stamp rev:
    uv run alembic stamp {{rev}}


# =========================
# DB / ê°œë°œ ìœ í‹¸
# =========================

# DB ì‰˜ ì§„ì… (psql) - DATABASE_URLì—ì„œ +asyncpg ì œê±°í•´ì„œ ì ‘ì†
# ì‚¬ìš© ì „: DATABASE_URL í™˜ê²½ë³€ìˆ˜ ì„¤ì • í•„ìš”
db-shell:
    @echo "ğŸ”— connecting to DB using \$DATABASE_URL..."
    @if [ -z "$DATABASE_URL" ]; then \
        echo "âŒ DATABASE_URL is not set"; \
        exit 1; \
    fi
    @psql "$${DATABASE_URL/+asyncpg/}"

# Python REPL (app ì»¨í…ìŠ¤íŠ¸ì—ì„œ)
py-shell:
    uv run python

# check FastAPI + ë¼ì´ë¸ŒëŸ¬ë¦¬ ë²„ì „ í™•ì¸
versions:
    uv run python -c "import sys; print('Python', sys.version)"
    uv run python -c "import fastapi, sqlalchemy; print('FastAPI', fastapi.__version__, 'SQLAlchemy', sqlalchemy.__version__)"
